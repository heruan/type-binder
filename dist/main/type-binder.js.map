{"version":3,"sources":["../../src/main/type-binder.ts"],"names":[],"mappings":"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","file":"type-binder.js","sourcesContent":["import \"reflect-metadata\";\nimport * as metadataKeys from \"./metadata-keys\";\n\nexport class TypeBinder {\n\n    private objectInstances: Map<any, Map<any, Object>> = new Map<any, Map<any, Object>>();\n\n    private identityBinding = (value, generics) => value;\n\n    private bindingCallbacks: Map<any, (value: any, generics: any[]) => any>;\n\n    public constructor() {\n        this.bindingCallbacks = new Map<any, (value: any, generics: any[]) => any>();\n        this.bindingCallbacks.set(Map, (value: [any, any][], generics: any[]) => new Map(\n            value.map(pair => <[{ }, { }]> [\n                this.bind(pair[0], generics[0]),\n                this.bind(pair[1], generics[1])\n            ])\n        ));\n        this.bindingCallbacks.set(Set, (value: any[], generics: any[]) => new Set(\n            value.map(element => this.bind(element, generics[0]))\n        ));\n        this.bindingCallbacks.set(Array, (value: any[], generics: any[]) => value.map(\n            element => this.bind(element, generics[0])\n        ));\n        this.bindingCallbacks.set(Number, this.identityBinding);\n        this.bindingCallbacks.set(String, this.identityBinding);\n        this.bindingCallbacks.set(Boolean, this.identityBinding);\n        this.bindingCallbacks.set(undefined, this.identityBinding);\n    }\n\n    public setBindingCallback(type: any, callback: (value: any, generics: any[]) => any): void {\n        this.bindingCallbacks.set(type, callback);\n    }\n\n    public bind<T>(value: any, type: new(...args) => T, ...generics: any[]): T {\n        if (Array.isArray(type)) {\n            generics = type.slice(1);\n            type = type[0];\n        }\n        if (this.bindingCallbacks.has(type)) {\n            return this.bindingCallbacks.get(type)(value, generics);\n        } else if (typeof value === \"object\") {\n            let object = this.createObject(type, value);\n            let properties = this.createProperties(type, object, value);\n            return Object.defineProperties(object, properties);\n        } else {\n            return value;\n        }\n    }\n\n    public isBound<T>(type: new(...args) => T, entity: T): boolean {\n        if (Reflect.hasMetadata(metadataKeys.binderIdentifierKey, type)) {\n            let scope = Reflect.getMetadata(metadataKeys.binderIdentifierScope, type) || type;\n            let key = Reflect.getMetadata(metadataKeys.binderIdentifierKey, type)(entity, this);\n            if (this.objectInstances.has(scope) && this.objectInstances.get(scope).has(key)) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    private createObject<T>(type: new(...args) => T, source: any): T {\n        let object: T;\n        if (Reflect.hasMetadata(metadataKeys.binderIdentifierKey, type)) {\n            let scope = Reflect.getMetadata(metadataKeys.binderIdentifierScope, type) || type;\n            let key = Reflect.getMetadata(metadataKeys.binderIdentifierKey, type)(source, this);\n            if (this.objectInstances.has(scope) && this.objectInstances.get(scope).has(key)) {\n                object = <T> this.objectInstances.get(scope).get(key);\n            } else {\n                object = Object.create(type.prototype);\n                if (!this.objectInstances.has(scope)) {\n                    this.objectInstances.set(scope, new Map<any, Object>());\n                }\n                this.objectInstances.get(scope).set(key, object);\n            }\n        } else {\n            object = Object.create(type.prototype);\n        }\n        return object;\n    }\n\n    private createProperties<T>(type: new(...args) => T, target: T, source: Object): PropertyDescriptorMap {\n        let properties: PropertyDescriptorMap = { };\n        Object.getOwnPropertyNames(source).forEach(property => {\n            let propertyType = Reflect.getMetadata(metadataKeys.designType, type.prototype, property);\n            let propertyGenerics = Reflect.getMetadata(metadataKeys.designGenericTypes, type.prototype, property);\n            properties[property] = {\n                configurable: false,\n                enumerable: true,\n                writable: true,\n                value: propertyType ? this.bind(source[property], propertyType, ...propertyGenerics) : source[property]\n            };\n            if (Reflect.hasMetadata(metadataKeys.binderPropertyTrack, type.prototype, property)) {\n                let trackingCallback: <V>(value: V) => V = Reflect.getMetadata(metadataKeys.binderPropertyTrack, type.prototype, property);\n                let value = trackingCallback(properties[property].value);\n                Reflect.defineMetadata(metadataKeys.binderPropertyTrackValue, value, target, property);\n            }\n            if (Reflect.hasMetadata(metadataKeys.binderPropertyEntries, type.prototype, property)) {\n                let trackingCallback: <I extends Iterable<V>, V>(iterable: I) => V[] = Reflect.getMetadata(metadataKeys.binderPropertyEntries, type.prototype, property);\n                let value = trackingCallback(properties[property].value);\n                Reflect.defineMetadata(metadataKeys.binderPropertyEntriesValue, value, target, property);\n            }\n        });\n        return properties;\n    }\n\n    public static propertyHasChanged(object: Object, property: string): boolean {\n        if (Reflect.hasMetadata(metadataKeys.binderPropertyTrackValue, object, property)) {\n            let currentValue = object[property];\n            let originalValue = Reflect.getMetadata(metadataKeys.binderPropertyTrackValue, object, property);\n            return currentValue !== originalValue;\n        } else {\n            return false;\n        }\n    }\n\n}\n"]}